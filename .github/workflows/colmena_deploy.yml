name: Environment Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      node:
        required: true
        type: string
      runner:
        required: true
        type: string
      pull_request_number:
        type: string

jobs:
  deploy:
    name: Environment Deploy
    environment: ${{ inputs.environment }}
    continue-on-error: true
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Install private ssh key
        uses: shimataro/ssh-key-action@d4fffb50872869abe2d9a9098a6d9c5aa7d16be4 # Install our ssh key. TODO: Replace with our own bash script
        with:
          key: ${{ secrets.COLMENA_SSH_KEY }}
          name: id_ed25519
          known_hosts: ${{ vars.COLMENA_KNOWN_HOSTS }}

      - name: Login to headscale
        uses: tailscale/github-action@8688eb839e58e6b25c1ae96cd99d1c173299b842 # Connect to headscale
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --login-server=https://vpn.tgstation13.org

      - name: Checkout (Branch)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        if: github.event_name != 'pull_request_target'

      - name: Checkout (PR Merge)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        if: github.event_name == 'pull_request_target'
        with:
          ref: "refs/pull/${{ inputs.pull_request_number }}/merge"

      - name: Mount compressed fs at /nix
        shell: bash
        run: |
          dd if=/dev/zero of=./nix-store.img bs=1 count=0 seek=15G
          mkfs.btrfs -M ./nix-store.img
          sudo mkdir /nix
          sudo mount -o defaults,noatime,compress=zstd ./nix-store.img /nix

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-args: --prefer-upstream-nix

      - name: Set up Nix magic cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          diagnostic-endpoint: ""

      - name: Deploy closure to Nodes
        # Prevent this step from being cancelled mid-run because it could leave the node in a bad state
        if: always() && success() && !cancelled()
        run: |
          COLMENA_REVISION=$(jq -r '.nodes.colmena.locked.rev' flake.lock)
          echo "Current Colmena revision is: $COLMENA_REVISION"
          nix run github:zhaofengli/colmena/$COLMENA_REVISION -- apply --impure -v --on ${{ inputs.node }}
